import { useState, useRef, useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { useLocation } from "wouter";
import { useMutation } from "@tanstack/react-query";
import { apiRequest } from "../lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { v4 as uuidv4 } from "uuid";

// ë©€í‹°ë¯¸ë””ì–´ ë¯¸ë¦¬ë³´ê¸° ì»´í¬ë„ŒíŠ¸ - í…ìŠ¤íŠ¸ ì—ë””í„° ë‚´ì— ì§ì ‘ ë Œë”ë§
interface MediaPreviewProps {
  content: string;
  compact?: boolean; // ìš”ì•½ ëª¨ë“œ (ë¯¸ë””ì–´ ì¸ë„¤ì¼ë§Œ í‘œì‹œ)
}

const MediaPreview = ({ content, compact = false }: MediaPreviewProps) => {
  if (!content.trim()) return null;
  
  // ì •ê·œì‹ íŒ¨í„´
  const markdownImageRegex = /!\[(.*?)\]\((.*?)\)/g;
  const uuidPattern = /([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/gi;
  const youtubeRegex = /https?:\/\/(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;
  const videoRegex = /<video[\s\S]*?<source src="(.*?)"[\s\S]*?<\/video>/g;
  const fileRegex = /\[íŒŒì¼ ë‹¤ìš´ë¡œë“œ: (.*?)\]\((.*?)\)/g;
  
  // ì´ë¯¸ì§€ ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€ (ìš”ì•½ ëª¨ë“œì—ì„œëŠ” ë¹„í™œì„±í™”)
  useEffect(() => {
    if (compact) return; // ìš”ì•½ ëª¨ë“œì—ì„œëŠ” ë“œë˜ê·¸ ì•ˆí•¨
    const enableDragAndDrop = () => {
      const container = document.querySelector('.media-preview');
      if (!container) return;
      
      // ëª¨ë“  ì´ë¯¸ì§€ì— ë“œë˜ê·¸ ì†ì„± ì¶”ê°€
      const images = container.querySelectorAll('img');
      images.forEach(img => {
        img.setAttribute('draggable', 'true');
        img.classList.add('editor-img');
        
        // ë“œë˜ê·¸ ì‹œì‘ ì´ë²¤íŠ¸
        img.addEventListener('dragstart', (e) => {
          if (!e.dataTransfer) return;
          img.classList.add('dragging-media');
          e.dataTransfer.setData('text/plain', 'dragging-image');
        });
        
        // ë“œë˜ê·¸ ì¢…ë£Œ ì´ë²¤íŠ¸
        img.addEventListener('dragend', () => {
          img.classList.remove('dragging-media');
        });
      });
    };
    
    // ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ í›„ ì´ë¯¸ì§€ ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
    setTimeout(enableDragAndDrop, 100);
    
    // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì •ë¦¬
    return () => {
      const container = document.querySelector('.media-preview');
      if (!container) return;
      
      const images = container.querySelectorAll('img');
      images.forEach(img => {
        img.removeAttribute('draggable');
      });
    };
  }, [content, compact]);
  
  // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ì™€ UUID í¬ë§· URLì„ HTML ì´ë¯¸ì§€ë¡œ ë³€í™˜
  const renderImages = (text: string) => {
    // UUID íŒ¨í„´ ì¸ì‹ ë° ì´ë¯¸ì§€ URLë¡œ ë³€í™˜
    let processedText = text.replace(uuidPattern, (match) => {
      const completeUrl = `/api/resources/media/${match}`;
      return `![ì´ë¯¸ì§€](${completeUrl})`;
    });
    
    // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ í˜•ì‹ ë³€í™˜
    return processedText.replace(markdownImageRegex, (match, alt, url) => {
      if (compact) {
        // ìš”ì•½ ëª¨ë“œ: ë” ì‘ì€ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼
        return `<img src="${url}" alt="${alt || 'ì´ë¯¸ì§€'}" class="editor-img inline-block h-8 w-8 object-cover rounded-md shadow-sm border border-border mx-1" />`;
      } else {
        // ì¼ë°˜ ëª¨ë“œ: ì „ì²´ í¬ê¸° ì´ë¯¸ì§€
        return `<img src="${url}" alt="${alt || 'ì´ë¯¸ì§€'}" class="editor-img max-w-full rounded-md shadow-sm border border-border my-2" />`;
      }
    });
  };
  
  // YouTube ì„ë² ë“œ ë³€í™˜
  const renderYouTube = (text: string) => {
    return text.replace(youtubeRegex, (match, videoId) => {
      if (compact) {
        // ìš”ì•½ ëª¨ë“œ: YouTube ì•„ì´ì½˜ìœ¼ë¡œ í‘œì‹œ
        return `<span class="inline-flex items-center bg-red-50 text-red-600 rounded-md px-2 py-1 text-xs font-medium mr-1 my-1">
          <svg class="h-3 w-3 mr-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z" fill="currentColor" />
            <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02" fill="#fff" />
          </svg>
          YouTube
        </span>`;
      } else {
        // ì¼ë°˜ ëª¨ë“œ: ì „ì²´ ìœ íŠœë¸Œ ì„ë² ë“œ
        return `
          <div class="youtube-embed my-3">
            <div class="aspect-video rounded-lg overflow-hidden shadow-md">
              <iframe 
                width="100%" 
                height="100%" 
                src="https://www.youtube.com/embed/${videoId}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen
              ></iframe>
            </div>
          </div>
        `;
      }
    });
  };
  
  // ë¹„ë””ì˜¤ íƒœê·¸ ì²˜ë¦¬
  const renderVideos = (text: string) => {
    if (compact) {
      // ìš”ì•½ ëª¨ë“œ: ë¹„ë””ì˜¤ë¥¼ ì•„ì´ì½˜ìœ¼ë¡œ ëŒ€ì²´
      return text.replace(videoRegex, () => {
        return `<span class="inline-flex items-center bg-blue-50 text-blue-600 rounded-md px-2 py-1 text-xs font-medium mr-1 my-1">
          <svg class="h-3 w-3 mr-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="6" width="15" height="12" rx="2" stroke="currentColor" stroke-width="2" />
            <path d="M22 12L17 8V16L22 12Z" fill="currentColor" />
          </svg>
          ë¹„ë””ì˜¤
        </span>`;
      });
    }
    return text; // ì¼ë°˜ ëª¨ë“œ: ì›ë³¸ ë¹„ë””ì˜¤ ìœ ì§€
  };
  
  // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ìŠ¤íƒ€ì¼ë§
  const renderFileLinks = (text: string) => {
    return text.replace(fileRegex, (match, fileName, url) => {
      if (compact) {
        // ìš”ì•½ ëª¨ë“œ: íŒŒì¼ì„ ì•„ì´ì½˜ìœ¼ë¡œ í‘œì‹œ
        return `<span class="inline-flex items-center bg-green-50 text-green-600 rounded-md px-2 py-1 text-xs font-medium mr-1 my-1">
          <svg class="h-3 w-3 mr-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" />
            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" />
            <path d="M16 13H8" stroke="currentColor" stroke-width="2" />
            <path d="M16 17H8" stroke="currentColor" stroke-width="2" />
            <path d="M10 9H9H8" stroke="currentColor" stroke-width="2" />
          </svg>
          íŒŒì¼
        </span>`;
      } else {
        // ì¼ë°˜ ëª¨ë“œ: ì „ì²´ ë‹¤ìš´ë¡œë“œ ë§í¬
        return `
          <a href="${url}" download="${fileName}" class="inline-flex items-center px-3 py-2 border border-input rounded-md bg-background hover:bg-accent transition-colors text-sm my-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            ${fileName}
          </a>
        `;
      }
    });
  };
  
  // URL ë§í¬ ì¹´ë“œë¡œ ë³€í™˜
  const renderUrlCards = (text: string) => {
    // ì´ë¯¸ì§€ì™€ YouTube URL ì œì™¸í•œ URL íŒ¨í„´
    const urlRegex = /https?:\/\/(?!.*\.(jpg|jpeg|png|gif|webp)(?:\?\S+)?$)(?!(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/))[^\s]+/gi;
    
    return text.replace(urlRegex, (url) => {
      try {
        const domain = new URL(url).hostname.replace('www.', '');
        
        if (compact) {
          // ìš”ì•½ ëª¨ë“œ: ê°„ë‹¨í•œ ë§í¬ ì•„ì´ì½˜
          return `<span class="inline-flex items-center bg-purple-50 text-purple-600 rounded-md px-2 py-1 text-xs font-medium mr-1 my-1">
            <svg class="h-3 w-3 mr-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 13C11.3132 14.3765 13.0267 15.1447 14.8285 15.1447C16.6303 15.1447 18.3438 14.3765 19.657 13C20.8846 11.6318 21.5918 9.83703 21.6518 7.95329C21.7118 6.06954 21.1198 4.22925 19.9861 2.77611C18.8524 1.32296 17.2437 0.388758 15.4647 0.16375C13.6858 -0.0612583 11.8846 0.437872 10.4308 1.55554C8.97695 2.67321 8.00335 4.33101 7.72636 6.15632C7.44938 7.98162 7.88986 9.84344 8.9445 11.3555" stroke="currentColor" stroke-width="2" />
              <path d="M14 11C12.6868 9.62349 10.9733 8.85526 9.17154 8.85526C7.36978 8.85526 5.65625 9.62349 4.343 11C3.11539 12.3682 2.40815 14.163 2.34817 16.0467C2.2882 17.9305 2.88019 19.7707 4.01389 21.2239C5.14759 22.677 6.75631 23.6112 8.53527 23.8362C10.3142 24.0613 12.1154 23.5621 13.5692 22.4445C15.0231 21.3268 15.9967 19.669 16.2736 17.8437C16.5506 16.0184 16.1101 14.1566 15.0555 12.6445" stroke="currentColor" stroke-width="2" />
            </svg>
            ${domain}
          </span>`;
        } else {
          // ì¼ë°˜ ëª¨ë“œ: ì „ì²´ URL ì¹´ë“œ
          return `
            <div class="url-card my-3">
              <div class="url-preview p-3 border rounded-lg shadow-sm bg-gray-50">
                <div class="flex items-center">
                  <div class="url-icon mr-3 text-xl">ğŸ”—</div>
                  <div class="url-content overflow-hidden">
                    <div class="url-title font-medium text-gray-900 truncate">${domain}</div>
                    <div class="url-link text-sm text-blue-600 truncate">
                      <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
      } catch (e) {
        return url;
      }
    });
  };
  
  // ëª¨ë“  ë³€í™˜ ì ìš© - ìµœì¢… HTML ìƒì„±
  let processedContent = content;
  processedContent = renderImages(processedContent);
  processedContent = renderYouTube(processedContent);
  processedContent = renderVideos(processedContent);
  processedContent = renderFileLinks(processedContent);
  processedContent = renderUrlCards(processedContent);
  
  // ì»¨í…Œì´ë„ˆ í´ë˜ìŠ¤ ì„¤ì • (ìš”ì•½ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¦„)
  const containerClass = compact 
    ? "media-preview media-preview-compact flex flex-wrap items-center gap-1 p-2 bg-gray-50 rounded-md border"
    : "media-preview";
  
  return (
    <div 
      className={containerClass}
      dangerouslySetInnerHTML={{ __html: processedContent }}
    />
  );
};

// UI ì»´í¬ë„ŒíŠ¸
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Separator } from "@/components/ui/separator";
import { Textarea } from "@/components/ui/textarea";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Alert, AlertTitle, AlertDescription } from "@/components/ui/alert";
import { Progress } from "@/components/ui/progress";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Calendar } from "@/components/ui/calendar";

// ì•„ì´ì½˜
import {
  ArrowLeft,
  ImageIcon,
  Trash2,
  Save,
  X,
  Upload,
  Clock,
  FileUp,
  UploadCloud,
  Plus,
  Tag,
  Info,
  AlertCircle,
  FileText,
  Check,
  ChevronRight,
  ChevronDown,
  ChevronLeft,
  Link2,
  Video,
  FolderOpen,
  Smile,
  CalendarIcon
} from "lucide-react";

// ì¹´í…Œê³ ë¦¬ ë¼ë²¨
const categoryLabels: Record<string, string> = {
  "hardware_design": "í•˜ë“œì›¨ì–´ ì„¤ê³„ë„",
  "software": "ì†Œí”„íŠ¸ì›¨ì–´ ì˜¤í”ˆì†ŒìŠ¤",
  "3d_model": "3D ëª¨ë¸ë§ íŒŒì¼",
  "ai_model": "AI ëª¨ë¸",
  "free_content": "í”„ë¦¬ ì½˜í…ì¸ ",
  "flash_game": "í”Œë˜ì‹œ ê²Œì„",
};

// ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ì˜µì…˜
const detailCategoryOptions = [
  { value: "arduino", label: "ì•„ë‘ì´ë…¸" },
  { value: "raspberry_pi", label: "ë¼ì¦ˆë² ë¦¬ íŒŒì´" },
  { value: "electronics", label: "ì „ìê³µí•™" },
  { value: "robotics", label: "ë¡œë³´í‹±ìŠ¤" },
  { value: "iot", label: "IoT" },
  { value: "game", label: "ê²Œì„" },
  { value: "utility", label: "ìœ í‹¸ë¦¬í‹°" },
  { value: "education", label: "êµìœ¡" },
  { value: "science", label: "ê³¼í•™" },
  { value: "art", label: "ì˜ˆìˆ " },
  { value: "music", label: "ìŒì•…" },
  { value: "other", label: "ê¸°íƒ€" },
];

// íŒŒì¼ íƒ€ì… ì¸í„°í˜ì´ìŠ¤
interface FileWithPreview extends File {
  preview?: string;
  progress?: number;
}

// í¼ ìœ íš¨ì„± ê²€ì‚¬ ìŠ¤í‚¤ë§ˆ - ëª¨ë“  í•„ë“œë¥¼ ì„ íƒ ì‚¬í•­ìœ¼ë¡œ ë³€ê²½í•˜ê³  ìµœì†Œ ë¬¸ììˆ˜ ì œí•œ ì œê±°
const formSchema = z.object({
  title: z.string().optional(),
  description: z.string().optional(),
  resourceType: z.string().default("hardware_design"),
  uploadDate: z.string().optional(),
  tags: z.string().optional(),
  downloadUrl: z.string().optional(),
  howToUse: z.string().optional(),
  assemblyInstructions: z.string().optional(),
  materials: z.string().optional(),
  dimensions: z.string().optional(),
  sourceSite: z.string().optional(),
  isFeatured: z.boolean().optional(),
});

export default function ResourceUploadPage() {
  const [_, setLocation] = useLocation();
  const { toast } = useToast();
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [thumbnailFile, setThumbnailFile] = useState<FileWithPreview | null>(null);
  const [galleryFiles, setGalleryFiles] = useState<FileWithPreview[]>([]);
  const [downloadFile, setDownloadFile] = useState<FileWithPreview | null>(null);
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const [currentTab, setCurrentTab] = useState<string>("basic");
  const [uploadProgress, setUploadProgress] = useState(0);
  const [resourceTypeInfo, setResourceTypeInfo] = useState<string>("");

  // ë¯¸ë””ì–´ ì—ë””í„° ê´€ë ¨ ìƒíƒœ
  const [urlInputActive, setUrlInputActive] = useState(false);
  const [urlInput, setUrlInput] = useState("");
  const [currentEditor, setCurrentEditor] = useState<string | null>(null);

  // ë¯¸ë””ì–´ íŒŒì¼ ì…ë ¥ ì°¸ì¡°
  const mediaImageInputRef = useRef<HTMLInputElement>(null);
  const mediaGifInputRef = useRef<HTMLInputElement>(null);
  const mediaVideoInputRef = useRef<HTMLInputElement>(null);
  const mediaFileInputRef = useRef<HTMLInputElement>(null);
  const urlInputRef = useRef<HTMLInputElement>(null);

  // í¼ ì´ˆê¸°í™”
  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      title: "",
      description: "",
      resourceType: "hardware_design", // ê¸°ë³¸ê°’ ì„¤ì •
      tags: "",
      downloadUrl: "",
      howToUse: "",
      assemblyInstructions: "",
      materials: "",
      dimensions: "",
      sourceSite: "",
      isFeatured: false,
    },
  });

  // ë¦¬ì†ŒìŠ¤ íƒ€ì… ë³€ê²½ ì‹œ ì •ë³´ ì—…ë°ì´íŠ¸
  const watchResourceType = form.watch("resourceType");
  useEffect(() => {
    switch(watchResourceType) {
      case 'hardware_design':
        setResourceTypeInfo("í•˜ë“œì›¨ì–´ ì„¤ê³„ë„ëŠ” ì „ì ê¸°ê¸°, íšŒë¡œ, 3D í”„ë¦°íŒ… ëª¨ë¸ ë“±ì˜ ì„¤ê³„ íŒŒì¼ì…ë‹ˆë‹¤. ì¡°ë¦½ ë°©ë²•ê³¼ í•„ìš”í•œ ì¬ë£Œë¥¼ ìƒì„¸íˆ ê¸°ì¬í•´ì£¼ì„¸ìš”.");
        break;
      case 'software':
        setResourceTypeInfo("ì†Œí”„íŠ¸ì›¨ì–´ ì˜¤í”ˆì†ŒìŠ¤ëŠ” ììœ ë¡­ê²Œ ì‚¬ìš©, ìˆ˜ì •, ë°°í¬í•  ìˆ˜ ìˆëŠ” ì½”ë“œì™€ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì„¤ì¹˜ ë° ì‚¬ìš© ë°©ë²•ì„ ëª…í™•íˆ ì•ˆë‚´í•´ì£¼ì„¸ìš”.");
        break;
      case '3d_model':
        setResourceTypeInfo("3D ëª¨ë¸ë§ íŒŒì¼ì€ 3D í”„ë¦°íŒ…ì´ë‚˜ ë””ì§€í„¸ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” 3ì°¨ì› ëª¨ë¸ì…ë‹ˆë‹¤. ê¶Œì¥ í”„ë¦°íŒ… ì„¤ì •ì„ í•¨ê»˜ ì œê³µí•´ì£¼ì„¸ìš”.");
        break;
      case 'ai_model':
        setResourceTypeInfo("AI ëª¨ë¸ì€ ë¨¸ì‹ ëŸ¬ë‹ ë˜ëŠ” ë”¥ëŸ¬ë‹ ëª¨ë¸ íŒŒì¼ì…ë‹ˆë‹¤. ëª¨ë¸ì˜ í›ˆë ¨ ë°©ë²•, ë°ì´í„°ì…‹, ì„±ëŠ¥ ì§€í‘œë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.");
        break;
      case 'free_content':
        setResourceTypeInfo("í”„ë¦¬ ì½˜í…ì¸ ëŠ” ë¬´ë£Œë¡œ ì´ìš© ê°€ëŠ¥í•œ ë””ì§€í„¸ ì½˜í…ì¸ ì…ë‹ˆë‹¤. ë¼ì´ì„¼ìŠ¤ ì •ë³´ì™€ ì¶œì²˜ë¥¼ ë°˜ë“œì‹œ ëª…ì‹œí•´ì£¼ì„¸ìš”.");
        break;
      case 'flash_game':
        setResourceTypeInfo("í”Œë˜ì‹œ ê²Œì„ì€ ì›¹ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•œ ê²Œì„ íŒŒì¼ì…ë‹ˆë‹¤. ê²Œì„ ì¡°ì‘ë²•ê³¼ ëª©í‘œë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”.");
        break;
      default:
        setResourceTypeInfo("");
    }
  }, [watchResourceType]);

  // ë¦¬ì†ŒìŠ¤ ìƒì„± ë®¤í…Œì´ì…˜
  const mutation = useMutation({
    mutationFn: async (formData: FormData) => {
      setIsUploading(true);
      const response = await apiRequest(
        "POST",
        "/api/resources/upload",
        formData,
        { 
          isFormData: true, 
          onProgress: (progress: number) => setUploadProgress(progress) 
        }
      );
      return await response.json();
    },
    onSuccess: (data) => {
      toast({
        title: "ë¦¬ì†ŒìŠ¤ ì—…ë¡œë“œ ì„±ê³µ",
        description: "ë¦¬ì†ŒìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.",
      });
      setIsUploading(false);
      setLocation("/admin/resources");
    },
    onError: (error: Error) => {
      setIsUploading(false);
      toast({
        title: "ì—…ë¡œë“œ ì‹¤íŒ¨",
        description: `ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`,
        variant: "destructive",
      });
    },
  });

  // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>, type: 'thumbnail' | 'gallery' | 'download') => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    const file = files[0] as FileWithPreview;
    file.preview = URL.createObjectURL(file);
    file.progress = 0;

    if (type === 'thumbnail') {
      setThumbnailFile(file);
    } else if (type === 'gallery') {
      setGalleryFiles(prev => [...prev, file]);
    } else if (type === 'download') {
      setDownloadFile(file);
    }

    // íŒŒì¼ ì„ íƒ í›„ input ì´ˆê¸°í™”
    e.target.value = '';
  };

  // ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ì‚­ì œ
  const removeGalleryFile = (index: number) => {
    setGalleryFiles(prev => prev.filter((_, i) => i !== index));
  };

  // í¼ ë¡œì»¬ ì €ì¥
  const saveFormLocally = () => {
    const formValues = form.getValues();
    localStorage.setItem("resourceForm", JSON.stringify(formValues));

    const filesInfo = {
      hasThumbnail: !!thumbnailFile,
      galleryCount: galleryFiles.length,
      hasDownload: !!downloadFile
    };
    localStorage.setItem("resourceFilesInfo", JSON.stringify(filesInfo));

    setLastSaved(new Date());
    toast({
      title: "ì„ì‹œ ì €ì¥ ì™„ë£Œ",
      description: "ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.",
    });
  };

  // ë¡œì»¬ ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  const loadLocalSave = () => {
    const savedForm = localStorage.getItem("resourceForm");
    if (savedForm) {
      try {
        const parsedForm = JSON.parse(savedForm);
        form.reset(parsedForm);

        toast({
          title: "ì„ì‹œ ì €ì¥ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ",
          description: "ë§ˆì§€ë§‰ìœ¼ë¡œ ì €ì¥ëœ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.",
        });
      } catch (e) {
        console.error("ì €ì¥ëœ í¼ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", e);
        toast({
          title: "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",
          description: "ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
          variant: "destructive",
        });
      }
    } else {
      toast({
        title: "ì €ì¥ëœ ë‚´ìš© ì—†ìŒ",
        description: "ë¶ˆëŸ¬ì˜¬ ì„ì‹œ ì €ì¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
        variant: "destructive",
      });
    }
  };

  // ë¦¬ì†ŒìŠ¤ ì—…ë¡œë“œ ì œì¶œ
  const onSubmit = async (values: z.infer<typeof formSchema>) => {
    try {
      const formData = new FormData();

      // ê¸°ë³¸ ì •ë³´ ì¶”ê°€
      Object.entries(values).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
          formData.append(key, String(value));
        }
      });
      
      // sourceSite í•„ë“œì— downloadUrl ê°’ì„ ë³µì‚¬ (ì¶œì²˜ ì‚¬ì´íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œ URLë¡œ í†µí•©)
      if (values.downloadUrl) {
        formData.append("sourceSite", String(values.downloadUrl));
      }

      // íŒŒì¼ ì¶”ê°€
      if (thumbnailFile) {
        formData.append("image", thumbnailFile);
      }

      galleryFiles.forEach((file, index) => {
        formData.append(`gallery_${index}`, file);
      });

      if (downloadFile) {
        formData.append("downloadFile", downloadFile);
      }

      await mutation.mutateAsync(formData);
    } catch (error) {
      console.error("í¼ ì œì¶œ ì˜¤ë¥˜:", error);
    }
  };



  // ë¯¸ë””ì–´ ì²¨ë¶€ ë„êµ¬ ê´€ë ¨ í•¨ìˆ˜ë“¤

  // ë¯¸ë””ì–´ ì²¨ë¶€ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤
  const handleMediaImageSelect = (fieldName: string) => {
    setCurrentEditor(fieldName);
    if (mediaImageInputRef.current) {
      mediaImageInputRef.current.value = '';
      mediaImageInputRef.current.click();
    }
  };

  const handleMediaGifSelect = (fieldName: string) => {
    setCurrentEditor(fieldName);
    if (mediaGifInputRef.current) {
      mediaGifInputRef.current.value = '';
      mediaGifInputRef.current.click();
    }
  };

  const handleMediaVideoSelect = (fieldName: string) => {
    setCurrentEditor(fieldName);
    if (mediaVideoInputRef.current) {
      mediaVideoInputRef.current.value = '';
      mediaVideoInputRef.current.click();
    }
  };

  const handleMediaFileSelect = (fieldName: string) => {
    setCurrentEditor(fieldName);
    if (mediaFileInputRef.current) {
      mediaFileInputRef.current.value = '';
      mediaFileInputRef.current.click();
    }
  };

  // URL ì…ë ¥ í† ê¸€
  const toggleUrlInput = (fieldName: string) => {
    setCurrentEditor(fieldName);
    setUrlInputActive(prev => !prev);
    if (!urlInputActive && urlInputRef.current) {
      setTimeout(() => urlInputRef.current?.focus(), 100);
    }
  };

  // ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
  const handleMediaImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0 || !currentEditor) return;

    const file = files[0];
    
    try {
      // í¼ ë°ì´í„° ì¤€ë¹„
      const formData = new FormData();
      formData.append('image', file);
      
      // ì´ë¯¸ì§€ ì—…ë¡œë“œ API í˜¸ì¶œ
      const response = await apiRequest(
        "POST",
        "/api/resources/upload-image",
        formData,
        { isFormData: true }
      );
      
      const data = await response.json();
      
      if (data.success && data.url) {
        // ì„±ê³µ ì‹œ ì—ë””í„°ì— ì´ë¯¸ì§€ ì¶”ê°€
        const markdownImage = `![${file.name}](${data.url})`;
        appendToEditor(currentEditor, markdownImage);
        
        toast({
          title: "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ",
          description: "ì´ë¯¸ì§€ê°€ ì—ë””í„°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.",
        });
      } else {
        throw new Error(data.message || "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
      }
    } catch (error) {
      console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
      toast({
        title: "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨",
        description: "ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
        variant: "destructive",
      });
    }
    
    // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
    e.target.value = '';
  };

  // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
  const handleMediaFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0 || !currentEditor) return;

    const file = files[0];
    
    try {
      // í¼ ë°ì´í„° ì¤€ë¹„
      const formData = new FormData();
      formData.append('file', file);
      
      // íŒŒì¼ ì—…ë¡œë“œ API í˜¸ì¶œ
      const response = await apiRequest(
        "POST",
        "/api/resources/upload-file",
        formData,
        { isFormData: true }
      );
      
      const data = await response.json();
      
      if (data.success && data.url) {
        // ì„±ê³µ ì‹œ ì—ë””í„°ì— íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ì¶”ê°€
        const fileMarkdown = `[íŒŒì¼ ë‹¤ìš´ë¡œë“œ: ${file.name}](${data.url})`;
        appendToEditor(currentEditor, fileMarkdown);
        
        toast({
          title: "íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ",
          description: "íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ì—ë””í„°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.",
        });
      } else {
        throw new Error(data.message || "íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
      }
    } catch (error) {
      console.error("íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
      toast({
        title: "íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨",
        description: "íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
        variant: "destructive",
      });
    }
    
    // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
    e.target.value = '';
  };

  // YouTube URL ì¶”ê°€
  const handleUrlAdd = () => {
    if (!urlInput.trim() || !currentEditor) {
      setUrlInputActive(false);
      setUrlInput("");
      return;
    }
    
    // YouTube URL ì¶”ê°€
    appendToEditor(currentEditor, urlInput.trim());
    
    // ìƒíƒœ ì´ˆê¸°í™”
    setUrlInputActive(false);
    setUrlInput("");
    setCurrentEditor(null);
  };

  // ì—ë””í„°ì— ì»¨í…ì¸  ì¶”ê°€ í—¬í¼ í•¨ìˆ˜
  const appendToEditor = (fieldName: string, content: string) => {
    const currentValue = form.getValues(fieldName as any) || '';
    const newValue = currentValue + (currentValue.length > 0 ? '\n\n' : '') + content;
    form.setValue(fieldName as any, newValue);
    
    // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (í…ìŠ¤íŠ¸ ì˜ì—­ì— ë³€ê²½ ì‚¬í•­ ë°˜ì˜)
    const textArea = document.getElementById(`${fieldName}`) as HTMLTextAreaElement;
    if (textArea) {
      updateTextareaFromPreview(document.querySelector('.media-preview') as HTMLElement, textArea);
    }
  };

  // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í…ìŠ¤íŠ¸ ì˜ì—­ìœ¼ë¡œ ë³€ê²½ ì‚¬í•­ ë°˜ì˜
  const updateTextareaFromPreview = (previewContent: HTMLElement, textAreaElement: HTMLTextAreaElement) => {
    if (!previewContent || !textAreaElement) return;
    // í…ìŠ¤íŠ¸ ì˜ì—­ì— ë³€ê²½ ì‚¬í•­ ë°˜ì˜ ë¡œì§ ì¶”ê°€
    // (í•„ìš”ì‹œ êµ¬í˜„)
  };

  // ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ
  const FilePreviewCard = ({ file, onDelete }: { file: FileWithPreview, onDelete: () => void }) => (
    <div className="relative border rounded-md overflow-hidden">
      <div className="aspect-square w-32 overflow-hidden">
        <img 
          src={file.preview} 
          alt={file.name} 
          className="w-full h-full object-cover transition-transform duration-200 hover:scale-110" 
        />
      </div>
      <button 
        type="button" 
        onClick={onDelete}
        className="absolute top-1 right-1 bg-black/60 text-white rounded-full p-1 hover:bg-black/80 transition-colors"
      >
        <X className="h-3 w-3" />
      </button>
      {file.progress !== undefined && file.progress < 100 && (
        <Progress value={file.progress} className="absolute bottom-0 left-0 right-0 h-1 rounded-none" />
      )}
    </div>
  );

  return (
    <div className="min-h-screen bg-background">
      <div className="container py-6 max-w-screen-lg mx-auto">
        {/* ìƒë‹¨ í—¤ë” */}
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center space-x-2">
            <Button 
              variant="ghost" 
              size="icon" 
              onClick={() => setLocation('/admin/resources')}
            >
              <ArrowLeft className="h-5 w-5" />
            </Button>
            <h1 className="text-2xl font-bold">ìë£Œ ì—…ë¡œë“œ</h1>
          </div>
          <div className="flex items-center space-x-2">
            {lastSaved && (
              <div className="text-xs text-muted-foreground flex items-center">
                <Clock className="h-3 w-3 mr-1" />
                <span>ì €ì¥ë¨: {lastSaved.toLocaleTimeString()}</span>
              </div>
            )}
            <Button 
              variant="outline" 
              size="sm"
              onClick={saveFormLocally}
            >
              <Save className="h-4 w-4 mr-1" />
              ì„ì‹œ ì €ì¥
            </Button>
            <Button 
              variant="outline" 
              size="sm"
              onClick={loadLocalSave}
            >
              <FolderOpen className="h-4 w-4 mr-1" />
              ë¶ˆëŸ¬ì˜¤ê¸°
            </Button>
          </div>
        </div>
        
        {/* ì—…ë¡œë“œ ì§„í–‰ í‘œì‹œì¤„ */}
        {isUploading && (
          <div className="mb-4">
            <div className="flex items-center justify-between mb-1">
              <span className="text-sm font-medium">ì—…ë¡œë“œ ì¤‘... {Math.round(uploadProgress)}%</span>
            </div>
            <Progress value={uploadProgress} className="h-2" />
          </div>
        )}
        
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            <Tabs 
              value={currentTab} 
              onValueChange={setCurrentTab}
              className="w-full"
            >
              <div className="mb-6">
                <TabsList className="w-full grid grid-cols-3 md:grid-cols-5 lg:grid-cols-6">
                  <TabsTrigger value="basic" className="gap-1">
                    <FileText className="h-4 w-4" />
                    <span className="hidden md:inline-block">ê¸°ë³¸ ì •ë³´</span>
                  </TabsTrigger>
                  <TabsTrigger value="details" className="gap-1">
                    <Info className="h-4 w-4" />
                    <span className="hidden md:inline-block">ìƒì„¸ ì •ë³´</span>
                  </TabsTrigger>
                  <TabsTrigger value="files" className="gap-1">
                    <UploadCloud className="h-4 w-4" />
                    <span className="hidden md:inline-block">íŒŒì¼ ì²¨ë¶€</span>
                  </TabsTrigger>
                </TabsList>
              </div>
              
              {/* ê¸°ë³¸ ì •ë³´ íƒ­ */}
              <TabsContent value="basic" className="space-y-6">
                <Card>
                  <CardContent className="pt-6 space-y-6">
                    <FormField
                      control={form.control}
                      name="title"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>ì œëª© <span className="text-red-500">*</span></FormLabel>
                          <FormControl>
                            <Input placeholder="ìë£Œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" {...field} />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="resourceType"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>ìë£Œ ìœ í˜• <span className="text-red-500">*</span></FormLabel>
                          <Select
                            onValueChange={field.onChange}
                            defaultValue={field.value}
                          >
                            <FormControl>
                              <SelectTrigger>
                                <SelectValue placeholder="ìë£Œ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”" />
                              </SelectTrigger>
                            </FormControl>
                            <SelectContent>
                              {Object.entries(categoryLabels).map(([value, label]) => (
                                <SelectItem key={value} value={value}>{label}</SelectItem>
                              ))}
                            </SelectContent>
                          </Select>
                          {resourceTypeInfo && (
                            <FormDescription>
                              <div className="flex items-start mt-2">
                                <Info className="h-4 w-4 mr-2 mt-0.5 text-blue-500" />
                                <span className="text-sm">{resourceTypeInfo}</span>
                              </div>
                            </FormDescription>
                          )}
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="tags"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>íƒœê·¸</FormLabel>
                          <div className="flex items-center space-x-2">
                            <Tag className="h-4 w-4 text-muted-foreground" />
                            <FormControl>
                              <Input placeholder="íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‰¼í‘œë¡œ êµ¬ë¶„)" {...field} />
                            </FormControl>
                          </div>
                          <FormDescription>
                            ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì—¬ëŸ¬ íƒœê·¸ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="description"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>ì„¤ëª…</FormLabel>
                          <div className="relative">
                            <FormControl>
                              <Textarea 
                                placeholder="ìë£Œì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                                className="min-h-32 resize-y"
                                id="description"
                                {...field} 
                              />
                            </FormControl>
                            
                            {/* ë¯¸ë””ì–´ ì²¨ë¶€ ë„êµ¬ */}
                            <div className="absolute right-3 bottom-3 flex space-x-1">
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => handleMediaImageSelect('description')}
                              >
                                <ImageIcon className="h-4 w-4" />
                              </Button>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => handleMediaVideoSelect('description')}
                              >
                                <Video className="h-4 w-4" />
                              </Button>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => handleMediaFileSelect('description')}
                              >
                                <FileUp className="h-4 w-4" />
                              </Button>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => toggleUrlInput('description')}
                              >
                                <Link2 className="h-4 w-4" />
                              </Button>
                            </div>
                          </div>
                          
                          {/* URL ì…ë ¥ í•„ë“œ */}
                          {urlInputActive && currentEditor === 'description' && (
                            <div className="mt-2 flex space-x-2">
                              <Input
                                ref={urlInputRef}
                                value={urlInput}
                                onChange={(e) => setUrlInput(e.target.value)}
                                placeholder="URLì„ ì…ë ¥í•˜ì„¸ìš” (YouTube ë“±)"
                                className="flex-1"
                                onKeyDown={(e) => e.key === 'Enter' && handleUrlAdd()}
                              />
                              <Button 
                                type="button" 
                                onClick={handleUrlAdd}
                                size="sm"
                              >
                                ì¶”ê°€
                              </Button>
                              <Button 
                                type="button" 
                                variant="outline" 
                                size="sm"
                                onClick={() => {
                                  setUrlInputActive(false);
                                  setUrlInput("");
                                }}
                              >
                                ì·¨ì†Œ
                              </Button>
                            </div>
                          )}
                          
                          {/* ë¯¸ë¦¬ë³´ê¸° */}
                          {field.value && (
                            <div className="mt-4">
                              <FormLabel className="text-sm text-muted-foreground">ë¯¸ë¦¬ë³´ê¸°</FormLabel>
                              <div className="mt-2 p-4 border rounded-md bg-muted/50">
                                <MediaPreview content={field.value} />
                              </div>
                            </div>
                          )}
                          
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </CardContent>
                </Card>
              </TabsContent>
              
              {/* ìƒì„¸ ì •ë³´ íƒ­ */}
              <TabsContent value="details" className="space-y-6">
                <Card>
                  <CardContent className="pt-6 space-y-6">
                    <FormField
                      control={form.control}
                      name="downloadUrl"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>ë‹¤ìš´ë¡œë“œ URL</FormLabel>
                          <FormControl>
                            <Input placeholder="ì™¸ë¶€ ë‹¤ìš´ë¡œë“œ ë§í¬ (ìˆëŠ” ê²½ìš°)" {...field} />
                          </FormControl>
                          <FormDescription>
                            ì™¸ë¶€ ì‚¬ì´íŠ¸ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” URLì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”.
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    <FormField
                      control={form.control}
                      name="howToUse"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>ì‚¬ìš© ë°©ë²•</FormLabel>
                          <div className="relative">
                            <FormControl>
                              <Textarea 
                                placeholder="ìë£Œ ì‚¬ìš© ë°©ë²•ì„ ì„¤ëª…í•˜ì„¸ìš”" 
                                className="min-h-32 resize-y" 
                                id="howToUse"
                                {...field} 
                              />
                            </FormControl>
                            
                            {/* ë¯¸ë””ì–´ ì²¨ë¶€ ë„êµ¬ */}
                            <div className="absolute right-3 bottom-3 flex space-x-1">
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => handleMediaImageSelect('howToUse')}
                              >
                                <ImageIcon className="h-4 w-4" />
                              </Button>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => handleMediaVideoSelect('howToUse')}
                              >
                                <Video className="h-4 w-4" />
                              </Button>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => handleMediaFileSelect('howToUse')}
                              >
                                <FileUp className="h-4 w-4" />
                              </Button>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-8 w-8 rounded-full"
                                onClick={() => toggleUrlInput('howToUse')}
                              >
                                <Link2 className="h-4 w-4" />
                              </Button>
                            </div>
                          </div>
                          
                          {/* URL ì…ë ¥ í•„ë“œ */}
                          {urlInputActive && currentEditor === 'howToUse' && (
                            <div className="mt-2 flex space-x-2">
                              <Input
                                ref={urlInputRef}
                                value={urlInput}
                                onChange={(e) => setUrlInput(e.target.value)}
                                placeholder="URLì„ ì…ë ¥í•˜ì„¸ìš” (YouTube ë“±)"
                                className="flex-1"
                                onKeyDown={(e) => e.key === 'Enter' && handleUrlAdd()}
                              />
                              <Button 
                                type="button" 
                                onClick={handleUrlAdd}
                                size="sm"
                              >
                                ì¶”ê°€
                              </Button>
                              <Button 
                                type="button" 
                                variant="outline" 
                                size="sm"
                                onClick={() => {
                                  setUrlInputActive(false);
                                  setUrlInput("");
                                }}
                              >
                                ì·¨ì†Œ
                              </Button>
                            </div>
                          )}
                          
                          {/* ë¯¸ë¦¬ë³´ê¸° */}
                          {field.value && (
                            <div className="mt-4">
                              <FormLabel className="text-sm text-muted-foreground">ë¯¸ë¦¬ë³´ê¸°</FormLabel>
                              <div className="mt-2 p-4 border rounded-md bg-muted/50">
                                <MediaPreview content={field.value} />
                              </div>
                            </div>
                          )}
                          
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                    
                    {watchResourceType === 'hardware_design' && (
                      <>
                        <FormField
                          control={form.control}
                          name="assemblyInstructions"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>ì¡°ë¦½ ë°©ë²•</FormLabel>
                              <div className="relative">
                                <FormControl>
                                  <Textarea 
                                    placeholder="ì¡°ë¦½ ë°©ë²•ì„ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•˜ì„¸ìš”" 
                                    className="min-h-32 resize-y" 
                                    id="assemblyInstructions"
                                    {...field} 
                                  />
                                </FormControl>
                                
                                {/* ë¯¸ë””ì–´ ì²¨ë¶€ ë„êµ¬ */}
                                <div className="absolute right-3 bottom-3 flex space-x-1">
                                  <Button
                                    type="button"
                                    variant="ghost"
                                    size="icon"
                                    className="h-8 w-8 rounded-full"
                                    onClick={() => handleMediaImageSelect('assemblyInstructions')}
                                  >
                                    <ImageIcon className="h-4 w-4" />
                                  </Button>
                                  <Button
                                    type="button"
                                    variant="ghost"
                                    size="icon"
                                    className="h-8 w-8 rounded-full"
                                    onClick={() => handleMediaVideoSelect('assemblyInstructions')}
                                  >
                                    <Video className="h-4 w-4" />
                                  </Button>
                                </div>
                              </div>
                              
                              {/* ë¯¸ë¦¬ë³´ê¸° */}
                              {field.value && (
                                <div className="mt-4">
                                  <FormLabel className="text-sm text-muted-foreground">ë¯¸ë¦¬ë³´ê¸°</FormLabel>
                                  <div className="mt-2 p-4 border rounded-md bg-muted/50">
                                    <MediaPreview content={field.value} />
                                  </div>
                                </div>
                              )}
                              
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="materials"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>í•„ìš”í•œ ì¬ë£Œ</FormLabel>
                              <FormControl>
                                <Textarea 
                                  placeholder="í•„ìš”í•œ ì¬ë£Œì™€ ë¶€í’ˆì„ ë‚˜ì—´í•˜ì„¸ìš”" 
                                  className="min-h-20 resize-y" 
                                  {...field} 
                                />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                        
                        <FormField
                          control={form.control}
                          name="dimensions"
                          render={({ field }) => (
                            <FormItem>
                              <FormLabel>ì¹˜ìˆ˜ ì •ë³´</FormLabel>
                              <FormControl>
                                <Input placeholder="ì¹˜ìˆ˜ ì •ë³´ (ê°€ë¡œxì„¸ë¡œxë†’ì´ ë“±)" {...field} />
                              </FormControl>
                              <FormMessage />
                            </FormItem>
                          )}
                        />
                      </>
                    )}
                    
                    <FormField
                      control={form.control}
                      name="sourceSite"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel>ì¶œì²˜</FormLabel>
                          <FormControl>
                            <Input placeholder="ì›ë³¸ ìë£Œì˜ ì¶œì²˜ (ì‚¬ì´íŠ¸, ì €ì ë“±)" {...field} />
                          </FormControl>
                          <FormDescription>
                            ì›ë³¸ ìë£Œì˜ ì¶œì²˜ë‚˜ ì œì‘ì ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
                          </FormDescription>
                          <FormMessage />
                        </FormItem>
                      )}
                    />
                  </CardContent>
                </Card>
              </TabsContent>
              
              {/* íŒŒì¼ ì²¨ë¶€ íƒ­ */}
              <TabsContent value="files" className="space-y-6">
                <Card>
                  <CardContent className="pt-6 space-y-6">
                    <div>
                      <h3 className="text-lg font-medium mb-2">ì¸ë„¤ì¼ ì´ë¯¸ì§€</h3>
                      <div className="flex items-start space-x-4">
                        <div className="flex-shrink-0 w-32">
                          {thumbnailFile ? (
                            <div className="relative aspect-square rounded-md overflow-hidden">
                              <img 
                                src={thumbnailFile.preview} 
                                alt="Thumbnail preview" 
                                className="w-full h-full object-cover" 
                              />
                              <button 
                                type="button" 
                                onClick={() => setThumbnailFile(null)}
                                className="absolute top-1 right-1 bg-black/60 text-white rounded-full p-1 hover:bg-black/80 transition-colors"
                              >
                                <X className="h-3 w-3" />
                              </button>
                            </div>
                          ) : (
                            <div 
                              className="aspect-square flex flex-col items-center justify-center border-2 border-dashed rounded-md text-muted-foreground hover:text-foreground"
                              onClick={() => fileInputRef.current?.click()}
                            >
                              <ImageIcon className="h-8 w-8 mb-2" />
                              <span className="text-xs text-center">ì´ë¯¸ì§€<br/>ì—…ë¡œë“œ</span>
                            </div>
                          )}
                        </div>
                        
                        <div className="flex-1">
                          <p className="text-sm text-muted-foreground mb-2">
                            ìë£Œë¥¼ ëŒ€í‘œí•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. ê¶Œì¥ í¬ê¸°ëŠ” 800x600pxì…ë‹ˆë‹¤.
                          </p>
                          <Button 
                            type="button" 
                            variant="outline"
                            size="sm"
                            onClick={() => fileInputRef.current?.click()}
                          >
                            <Upload className="h-4 w-4 mr-2" />
                            ì´ë¯¸ì§€ ì„ íƒ
                          </Button>
                          <input 
                            type="file" 
                            ref={fileInputRef}
                            className="hidden"
                            accept="image/*"
                            onChange={(e) => handleFileSelect(e, 'thumbnail')}
                          />
                        </div>
                      </div>
                    </div>
                    
                    <Separator />
                    
                    <div>
                      <h3 className="text-lg font-medium mb-2">ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€</h3>
                      <p className="text-sm text-muted-foreground mb-4">
                        ìë£Œë¥¼ ë³´ì—¬ì£¼ëŠ” ì¶”ê°€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. ìµœëŒ€ 5ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                      </p>
                      
                      <div className="flex flex-wrap gap-4">
                        {galleryFiles.map((file, index) => (
                          <FilePreviewCard 
                            key={index} 
                            file={file} 
                            onDelete={() => removeGalleryFile(index)} 
                          />
                        ))}
                        
                        {galleryFiles.length < 5 && (
                          <div 
                            className="w-32 aspect-square flex flex-col items-center justify-center border-2 border-dashed rounded-md text-muted-foreground hover:text-foreground"
                            onClick={() => {
                              const input = document.createElement('input');
                              input.type = 'file';
                              input.accept = 'image/*';
                              input.onchange = (e) => handleFileSelect(e as React.ChangeEvent<HTMLInputElement>, 'gallery');
                              input.click();
                            }}
                          >
                            <Plus className="h-8 w-8 mb-2" />
                            <span className="text-xs text-center">ì´ë¯¸ì§€<br/>ì¶”ê°€</span>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <Separator />
                    
                    <div>
                      <h3 className="text-lg font-medium mb-2">ë‹¤ìš´ë¡œë“œ íŒŒì¼</h3>
                      <div className="flex items-start space-x-4">
                        <div className="flex-shrink-0">
                          {downloadFile ? (
                            <div className="border rounded-md p-3 bg-muted w-60">
                              <div className="flex items-center">
                                <FileText className="h-8 w-8 mr-2 text-blue-500" />
                                <div className="overflow-hidden flex-1">
                                  <p className="font-medium truncate">{downloadFile.name}</p>
                                  <p className="text-xs text-muted-foreground">{(downloadFile.size / 1024 / 1024).toFixed(2)} MB</p>
                                </div>
                                <button 
                                  type="button" 
                                  onClick={() => setDownloadFile(null)}
                                  className="text-muted-foreground hover:text-foreground transition-colors"
                                >
                                  <X className="h-4 w-4" />
                                </button>
                              </div>
                            </div>
                          ) : (
                            <Button 
                              type="button" 
                              variant="outline"
                              onClick={() => {
                                const input = document.createElement('input');
                                input.type = 'file';
                                input.onchange = (e) => handleFileSelect(e as React.ChangeEvent<HTMLInputElement>, 'download');
                                input.click();
                              }}
                            >
                              <FileUp className="h-4 w-4 mr-2" />
                              íŒŒì¼ ì—…ë¡œë“œ
                            </Button>
                          )}
                        </div>
                        
                        <div className="flex-1">
                          <p className="text-sm text-muted-foreground">
                            ì‚¬ìš©ìê°€ ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. ì••ì¶• íŒŒì¼(ZIP)ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                          </p>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>
            
            <div className="pt-6 space-x-2 flex justify-end">
              <Button
                type="button"
                variant="outline"
                disabled={isUploading}
                onClick={() => setLocation('/admin/resources')}
              >
                ì·¨ì†Œ
              </Button>
              <Button 
                type="submit"
                disabled={isUploading}
              >
                {isUploading ? (
                  <span className="flex items-center">
                    <span className="animate-spin mr-2">
                      <UploadCloud className="h-4 w-4" />
                    </span>
                    ì—…ë¡œë“œ ì¤‘...
                  </span>
                ) : (
                  <span className="flex items-center">
                    <Upload className="h-4 w-4 mr-2" />
                    ìë£Œ ì—…ë¡œë“œ
                  </span>
                )}
              </Button>
            </div>
          </form>
        </Form>
        
        {/* íˆë“  íŒŒì¼ ì…ë ¥ í•„ë“œ */}
        <input 
          type="file" 
          ref={mediaImageInputRef}
          className="hidden"
          accept="image/*"
          onChange={handleMediaImageUpload}
        />
        <input 
          type="file" 
          ref={mediaGifInputRef}
          className="hidden"
          accept="image/gif"
          onChange={handleMediaImageUpload}
        />
        <input 
          type="file" 
          ref={mediaVideoInputRef}
          className="hidden"
          accept="video/*"
          onChange={handleMediaImageUpload}
        />
        <input 
          type="file" 
          ref={mediaFileInputRef}
          className="hidden"
          onChange={handleMediaFileUpload}
        />
      </div>
    </div>
  );
}