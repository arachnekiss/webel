name: Stage 3 - Performance Tests

on:
  push:
    branches: [ main, develop, stage-qa-e2e ]
  pull_request:
    branches: [ main ]
    
jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      - name: Install k6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/v0.45.0/k6-v0.45.0-linux-amd64.tar.gz -o k6.tar.gz
          tar -xzf k6.tar.gz
          sudo cp k6-v0.45.0-linux-amd64/k6 /usr/local/bin
      
      - name: Start server in background
        run: |
          npm run dev &
          sleep 30
      
      - name: Run K6 performance tests (30 VU Ã— 2m)
        run: |
          k6 run performance/basic-load-test.js
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/resources
            http://localhost:3000/services
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3