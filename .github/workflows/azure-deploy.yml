name: Deploy to Azure Web App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies and build
      run: |
        echo "=== 1. ì„œë²„ ë° í´ë¼ì´ì–¸íŠ¸ ì¢…ì†ì„± ì„¤ì¹˜ ==="
        npm ci
        
        echo "=== 2. ì„œë²„ ë° í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ==="
        # í”„ë¡œì íŠ¸ ë¹Œë“œ (ì„œë²„ ì¸¡ dist/ ìƒì„±)
        npm run build
        
        # ë¹Œë“œ ê²°ê³¼ í™•ì¸
        if [ -d dist ]; then
          echo "ì„œë²„ ë¹Œë“œ ì™„ë£Œ: dist/ ë””ë ‰í† ë¦¬ ìƒì„±ë¨"
          ls -la dist/
        else
          echo "ì˜¤ë¥˜: ì„œë²„ ë¹Œë“œ ì‹¤íŒ¨. dist/ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
        fi
        
        # í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ì²˜ë¦¬ í™•ì¸
        echo "=== 3. í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
        if [ -d client/dist ]; then
          echo "í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ì™„ë£Œ: client/dist ë””ë ‰í† ë¦¬ ì¡´ì¬í•¨"
          ls -la client/dist/
        else
          echo "ì°¸ê³ : client/dist ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹  client/srcë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
        fi
      env:
        CI: true
    
    - name: Run database migrations
      run: |
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ìì—´ ì§ì ‘ ì§€ì • (ë””ë²„ê¹…ìš©)
        export DATABASE_URL="${{ secrets.DATABASE_URL }}"
        
        # í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹… ì¶œë ¥
        echo "ğŸ” DATABASE_URL í™•ì¸:"
        echo "- í™˜ê²½ ë³€ìˆ˜ì— DATABASE_URL ì¡´ì¬ ì—¬ë¶€: $(if [ -n "$DATABASE_URL" ]; then echo "ìˆìŒ"; else echo "ì—†ìŒ"; fi)"
        echo "- DATABASE_URL ê¸¸ì´: ${#DATABASE_URL} ê¸€ì"
        
        # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env.production)
        echo "ğŸ”„ .env.production íŒŒì¼ ìƒì„± ì¤‘..."
        echo "DATABASE_URL=$DATABASE_URL" > .env.production
        echo "NODE_ENV=production" >> .env.production
        echo "SKIP_MIGRATION=true" >> .env.production  # Azureì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° í”Œë˜ê·¸ ì¶”ê°€
        
        # íŒŒì¼ ë‚´ìš© í™•ì¸ (ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹í•˜ì—¬ ì¶œë ¥)
        echo "ğŸ” .env.production íŒŒì¼ ë‚´ìš© í™•ì¸:"
        grep -v "DATABASE_URL" .env.production || true
        echo "DATABASE_URL=********(ì„¤ì •ë¨)********"
        
        # env.production íŒŒì¼ë„ ìƒì„± (ì  ì—†ëŠ” ë²„ì „, Azureì—ì„œ ìˆ¨ê¹€ íŒŒì¼ ë¬¸ì œ ë°©ì§€)
        cp .env.production env.production
        echo "âœ… env.production íŒŒì¼ë„ ìƒì„± ì™„ë£Œ"
        
        # ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ê²½ ì¤€ë¹„ í™•ì¸
        ls -la drizzle.config.* || true
        
        # drizzle-kitì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (global ì„¤ì¹˜ ì‹œë„)
        echo "ğŸ” drizzle-kit ì„¤ì¹˜ ìƒíƒœ í™•ì¸..."
        if ! npm list -g drizzle-kit &> /dev/null; then
          echo "ğŸ”„ drizzle-kitì„ ê¸€ë¡œë²Œë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
          npm install -g drizzle-kit
          echo "âœ… drizzle-kit ê¸€ë¡œë²Œ ì„¤ì¹˜ ì™„ë£Œ"
        else
          echo "âœ… drizzle-kitì´ ì´ë¯¸ ê¸€ë¡œë²Œë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        fi
        
        # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ë¡œì»¬ drizzle-kit ëª¨ë“ˆ ì•„ë‹ˆë¼ ê¸€ë¡œë²Œ drizzle-kit ì‚¬ìš©)
        echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤..."
        
        # 1. ê¸€ë¡œë²Œ drizzle-kit ì§ì ‘ ì‹¤í–‰ 
        echo "ë°©ë²• 1: ê¸€ë¡œë²Œ drizzle-kit push ì‹¤í–‰"
        DATABASE_URL="$DATABASE_URL" drizzle-kit push || true
        
        # 2. SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰
        echo "ë°©ë²• 2: SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰"
        # SQL ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
        DATABASE_URL="$DATABASE_URL" drizzle-kit generate:pg --out=./migration.sql || true
        
        # migration.sql íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if [ -f "./migration.sql" ]; then
          echo "âœ… SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ë¨"
          echo "ğŸ’¾ migration.sql ë‚´ìš©:"
          cat ./migration.sql | grep -v 'password' || true
          
          # ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ Azureì— í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ ë³µì‚¬
          cp ./migration.sql deployment/ || true
        else
          echo "âš ï¸ SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ìµœì‹  ìƒíƒœì¼ ìˆ˜ ìˆìŒ)"
        fi
        
        echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"
    
    - name: Prepare deployment package
      run: |
        # ì§ì ‘ ZIP íŒ¨í‚¤ì§€ ìƒì„± (ì¤‘ê°„ í´ë” ì—†ì´)
        DEPLOY_DIR="deploy_package"
        rm -rf $DEPLOY_DIR || true
        mkdir -p $DEPLOY_DIR
        
        echo "ğŸ” ë¹Œë“œ ê²°ê³¼ í™•ì¸:"
        ls -la dist/ || echo "dist/ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
        ls -la client/ || echo "client/ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
        
        # 1. ì„œë²„ ë¹Œë“œ íŒŒì¼ ë³µì‚¬ (dist ë‚´ìš©ë¬¼ì„ ë£¨íŠ¸ë¡œ ë³µì‚¬)
        if [ -d dist ]; then
          cp -r dist/* $DEPLOY_DIR/
          echo "âœ… ì„œë²„ ë¹Œë“œ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ (dist/* â†’ $DEPLOY_DIR/)"
        else
          echo "âš ï¸ ê²½ê³ : dist ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹Œë“œê°€ ì œëŒ€ë¡œ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
        fi
        
        # 2. í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ ë³µì‚¬
        mkdir -p $DEPLOY_DIR/client
        if [ -d client/dist ]; then
          cp -r client/dist $DEPLOY_DIR/client/
          echo "âœ… í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
        else
          mkdir -p $DEPLOY_DIR/client/src
          cp -r client/src $DEPLOY_DIR/client/
          echo "âœ… í´ë¼ì´ì–¸íŠ¸ ì†ŒìŠ¤ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
        fi
        
        # 3. ì£¼ìš” íŒŒì¼ë“¤ì„ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì— ë³µì‚¬
        cp package.json package-lock.json $DEPLOY_DIR/
        cp startup.js patch-helper.js $DEPLOY_DIR/
        cp web.config .deployment $DEPLOY_DIR/
        
        # 4. í•„ìˆ˜ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì½˜í…ì¸  ë³µì‚¬
        mkdir -p $DEPLOY_DIR/public/images $DEPLOY_DIR/public/static
        mkdir -p $DEPLOY_DIR/server
        mkdir -p $DEPLOY_DIR/shared
        mkdir -p $DEPLOY_DIR/uploads $DEPLOY_DIR/temp
        
        # 5. ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìœ¼ë©´ ë³µì‚¬
        if [ -f migration.sql ]; then
          cp migration.sql $DEPLOY_DIR/
          echo "âœ… SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬ ì™„ë£Œ"
        fi
        
        # 6. drizzle.config.ts íŒŒì¼ ë³µì‚¬
        cp drizzle.config.ts $DEPLOY_DIR/
        
        # 7. shared ë””ë ‰í† ë¦¬ ë‚´ìš©ë¬¼ ë³µì‚¬
        cp -r shared/* $DEPLOY_DIR/shared/ || echo "shared ë””ë ‰í† ë¦¬ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
        
        # 8. server/startup.js í˜¸í™˜ì„± íŒŒì¼ ìƒì„±
        echo "// Azure Kudu ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ í˜¸í™˜ì„± íŒŒì¼" > $DEPLOY_DIR/server/startup.js
        echo "import '../startup.js'; // ë£¨íŠ¸ì˜ startup.jsë¡œ ë¦¬ë””ë ‰ì…˜" >> $DEPLOY_DIR/server/startup.js
        chmod +x $DEPLOY_DIR/server/startup.js
        echo "âœ… server/startup.js íŒŒì¼ ìƒì„± ì™„ë£Œ (ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ë¨)"
        
        # 9. startup.jsì—ë„ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        chmod +x $DEPLOY_DIR/startup.js
        echo "âœ… startup.js íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ë¨"
        
        # 10. í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬
        if [ -f .env.production ]; then
          cp .env.production $DEPLOY_DIR/
          cp .env.production $DEPLOY_DIR/env.production  # ì  ì—†ëŠ” ë²„ì „ë„ ì¶”ê°€
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
        fi
        
        # 11. public ë””ë ‰í† ë¦¬ ë‚´ìš©ë¬¼ ë³µì‚¬
        if [ -d public ] && [ ! -f public ]; then
          cp -r public/* $DEPLOY_DIR/public/ || echo "public ë””ë ‰í† ë¦¬ ë‚´ìš©ë¬¼ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
          echo "âœ… public ë””ë ‰í† ë¦¬ ë‚´ìš©ë¬¼ ë³µì‚¬ ì™„ë£Œ"
        fi
        
        # 12. node_modules ë³µì‚¬
        echo "ğŸ“¦ node_modules ë³µì‚¬ ì¤‘..."
        cp -r node_modules $DEPLOY_DIR/
        echo "âœ… node_modules ë³µì‚¬ ì™„ë£Œ"
        
        # 13. íŒ¨í‚¤ì§€ êµ¬ì¡° í™•ì¸ (ì£¼ìš” íŒŒì¼ ëª©ë¡)
        echo "ğŸ“‹ ìµœì¢… ë°°í¬ íŒ¨í‚¤ì§€ ì£¼ìš” íŒŒì¼:"
        find $DEPLOY_DIR -maxdepth 2 -type f | sort
        
        # 14. ì´ íŒ¨í‚¤ì§€ë¥¼ deploymentë¡œ ì˜®ê²¨ ë°°í¬ ì¤€ë¹„
        rm -rf deployment || true
        mv $DEPLOY_DIR deployment
    
    - name: Verify Azure CLI Installation
      run: |
        echo "ğŸ” Azure CLI ì„¤ì¹˜ ìƒíƒœ í™•ì¸ ì¤‘..."
        # GitHub Actionsì˜ Ubuntu í™˜ê²½ì—ëŠ” ì´ë¯¸ Azure CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŒ
        if command -v az &> /dev/null; then
          echo "âœ… Azure CLIê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
          az --version | head -n 1
        else
          echo "âš ï¸ Azure CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
          echo "âš ï¸ ë‹¤ìŒ ë‹¨ê³„ì—ì„œëŠ” Azure CLI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
        fi
    
    - name: Clean Up App Service (Optional)
      run: |
        # Azureì— ë¡œê·¸ì¸ ì‹œë„ (publish profile ì‚¬ìš©) - ë¡œê·¸ì¸ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
        PUBLISH_PROFILE="${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}"
        APP_NAME="${{ secrets.AZURE_WEBAPP_NAME }}"
        
        echo "ğŸ” Azure App Service í™˜ê²½ ì¤€ë¹„ ì¤‘..."
        
        # Azure CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆê³  Azure ìê²© ì¦ëª…ì´ ì œê³µëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        if command -v az &> /dev/null && [ -n "$PUBLISH_PROFILE" ] && [ -n "$APP_NAME" ]; then
          echo "ğŸ”„ Azure CLI ì‚¬ìš© ê°€ëŠ¥, ìê²© ì¦ëª… í™•ì¸ë¨"
          
          # ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰í•˜ë„ë¡ ì„¤ì • (ì˜¤ë¥˜ ë°œìƒ ìœ„ì¹˜ ìˆ˜ì •)
          set +e
          
          # ë¡œê¹…ë§Œ ìˆ˜í–‰ (ì‹¤ì œ ë™ì‘ ì—†ìŒ) - ì•ˆì „ ëª¨ë“œë¡œ ìœ ì§€
          echo "âš ï¸ ì°¸ê³ : ì‹¤ì œ ì •ë¦¬ ì‘ì—…ì€ Azure í¬í„¸ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤."
          echo "âš ï¸ ë°°í¬ëŠ” ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤."
          
          # ì›ë˜ ì˜¤ë¥˜ ì²˜ë¦¬ ë°©ì‹ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          set -e
        else
          echo "âš ï¸ Azure CLI ë˜ëŠ” ìê²© ì¦ëª…ì´ ì—†ì–´ App Service ì •ë¦¬ ë‹¨ê³„ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
        fi
        
        echo "âœ… Azure í™˜ê²½ ì¤€ë¹„ ë‹¨ê³„ ì™„ë£Œ"
    
    - name: Create Custom ZIP Package
      run: |
        # ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ZIP íŒŒì¼ ìƒì„± (ìƒëŒ€ ê²½ë¡œë¡œ)
        echo "ğŸ“¦ deploy.zip íŒ¨í‚¤ì§€ ìƒì„± ì¤‘..."
        cd deployment
        # node_modules í¬ê¸°ë¥¼ ì¤„ì´ê¸° ìœ„í•´ ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
        find node_modules -name "*.md" -delete || true
        find node_modules -name "*.d.ts" -delete || true
        find node_modules -name "*.map" -delete || true
        find node_modules -path "*/test/*" -delete || true
        find node_modules -path "*/tests/*" -delete || true
        find node_modules -path "*/docs/*" -delete || true
        
        # ìµœì¢… ZIP íŒ¨í‚¤ì§€ ìƒì„± (ê°œì„ ëœ ì••ì¶•)
        zip -r ../deploy.zip * -x "*.git*" "*.github*" "node_modules/.cache/*" "node_modules/.bin/*"
        cd ..
        
        # ZIP íŒŒì¼ í¬ê¸° í™•ì¸
        ls -lh deploy.zip
        echo "âœ… ZIP íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ (ìµœì í™”ë¨)"
    
    - name: Verify ZIP Package (ì¤‘ìš” íŒŒì¼ í™•ì¸)
      run: |
        # ZIP íŒŒì¼ ë¬´ê²°ì„± ë° ë‚´ìš©ë¬¼ ê²€ì‚¬
        echo "ğŸ” ZIP íŒŒì¼ ê²€ì¦ ì¤‘..."
        
        # ZIP íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ ! -f "deploy.zip" ]; then
          echo "âš ï¸ ì˜¤ë¥˜: deploy.zip íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # ZIP íŒŒì¼ í¬ê¸° í™•ì¸
        ZIP_SIZE=$(stat -c%s "deploy.zip")
        echo "ğŸ“Š ZIP íŒŒì¼ í¬ê¸°: $ZIP_SIZE ë°”ì´íŠ¸"
        
        # ZIP íŒŒì¼ êµ¬ì¡° í™•ì¸ - ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ íŒŒì´í”„ë¼ì¸ ëŒ€ì‹  ëª…ì‹œì  ì„ì‹œ íŒŒì¼ ì‚¬ìš©
        echo "ğŸ“‹ ZIP íŒŒì¼ ë‚´ìš©ë¬¼ ëª©ë¡ (ì£¼ìš” íŒŒì¼):"
        unzip -l deploy.zip > zip_contents.txt
        grep -E 'startup.js|web.config|package.json|node_modules/|server/|shared/|dist/' zip_contents.txt || echo "âš ï¸ ì£¼ìš” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        
        # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
        echo "ğŸ” í•„ìˆ˜ íŒŒì¼ í™•ì¸ ì¤‘..."
        
        # í•„ìˆ˜ íŒŒì¼ ëª©ë¡
        REQUIRED_FILES=("startup.js" "web.config" "package.json" "server/startup.js")
        MISSING_FILES=()
        
        for file in "${REQUIRED_FILES[@]}"; do
          if ! grep -q "$file" zip_contents.txt; then
            MISSING_FILES+=("$file")
          fi
        done
        
        # ì„ì‹œ íŒŒì¼ ì •ë¦¬
        rm zip_contents.txt
        
        if [ "${#MISSING_FILES[@]}" -gt 0 ]; then
          echo "âš ï¸ ê²½ê³ : ë‹¤ìŒ í•„ìˆ˜ íŒŒì¼ì´ ZIP íŒ¨í‚¤ì§€ì— ì—†ìŠµë‹ˆë‹¤:"
          for missing in "${MISSING_FILES[@]}"; do
            echo "  - $missing"
          done
          
          echo "ğŸ”„ ZIP íŒŒì¼ì„ ìˆ˜ì •í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤..."
          
          # í•„ìˆ˜ íŒŒì¼ ê¸´ê¸‰ ì¶”ê°€
          mkdir -p fix_missing
          cd fix_missing
          
          # server/startup.js íŒŒì¼ì´ ëˆ„ë½ëœ ê²½ìš°
          if echo "${MISSING_FILES[@]}" | grep -q "server/startup.js"; then
            mkdir -p server
            echo "// Azure Kudu ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ í˜¸í™˜ì„± íŒŒì¼" > server/startup.js
            echo "import '../startup.js'; // ë£¨íŠ¸ì˜ startup.jsë¡œ ë¦¬ë””ë ‰ì…˜" >> server/startup.js
            chmod +x server/startup.js
            echo "âœ… server/startup.js íŒŒì¼ ìƒì„± ì™„ë£Œ"
          fi
          
          # ZIP íŒŒì¼ì— í•„ìš”í•œ íŒŒì¼ ì¶”ê°€
          if [ -d "server" ]; then
            zip -r ../deploy.zip server/
            echo "âœ… ëˆ„ë½ëœ íŒŒì¼ ZIPì— ì¶”ê°€ ì™„ë£Œ"
          fi
          
          cd ..
          rm -rf fix_missing
        else
          echo "âœ… ëª¨ë“  í•„ìˆ˜ íŒŒì¼ì´ ZIP íŒ¨í‚¤ì§€ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        fi
        
        echo "âœ… ZIP íŒ¨í‚¤ì§€ ê²€ì¦ ì™„ë£Œ"
    
    - name: Deploy to Azure Web App (ì§ì ‘ ZIP ë°°í¬)
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./deploy.zip
        clean: true
        restart: true
        
    - name: Verify Deployment
      run: |
        echo "âœ… Azure App Serviceì— ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        echo "ğŸ“ ë°°í¬ í›„ í™•ì¸ ì‚¬í•­:"
        echo "  1. Azure í¬í„¸ì—ì„œ ì•± ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸ (Kudu/Log stream)"
        echo "  2. ë°°í¬ëœ ì•±ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸"
        echo "  3. ì‹œì‘ ëª…ë ¹ì´ 'node startup.js'ì¸ì§€ í™•ì¸ (êµ¬ì„± > ì¼ë°˜ ì„¤ì • > ì‹œì‘ ëª…ë ¹)"
        echo "  4. í™˜ê²½ ë³€ìˆ˜ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (êµ¬ì„± > ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •)"
        
        # GitHub ë¡œê·¸ì— ë°°í¬ URL ì¶œë ¥
        echo "ğŸŒ ë°°í¬ëœ ì•± URL: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net"