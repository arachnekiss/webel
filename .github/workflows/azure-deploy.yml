name: Deploy to Azure Web App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies and build
      run: |
        echo "=== 1. ì„œë²„ ë° í´ë¼ì´ì–¸íŠ¸ ì¢…ì†ì„± ì„¤ì¹˜ ==="
        npm ci
        
        echo "=== 2. ì„œë²„ ë° í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ==="
        # í”„ë¡œì íŠ¸ ë¹Œë“œ (ì„œë²„ ì¸¡ dist/ ìƒì„±)
        npm run build
        
        # ë¹Œë“œ ê²°ê³¼ í™•ì¸
        if [ -d dist ]; then
          echo "ì„œë²„ ë¹Œë“œ ì™„ë£Œ: dist/ ë””ë ‰í† ë¦¬ ìƒì„±ë¨"
          ls -la dist/
        else
          echo "ì˜¤ë¥˜: ì„œë²„ ë¹Œë“œ ì‹¤íŒ¨. dist/ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
        fi
        
        # í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ì²˜ë¦¬ í™•ì¸
        echo "=== 3. í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
        if [ -d client/dist ]; then
          echo "í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ ì™„ë£Œ: client/dist ë””ë ‰í† ë¦¬ ì¡´ì¬í•¨"
          ls -la client/dist/
        else
          echo "ì°¸ê³ : client/dist ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹  client/srcë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
        fi
      env:
        CI: true
    
    - name: Run database migrations
      run: |
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ìì—´ ì§ì ‘ ì§€ì • (ë””ë²„ê¹…ìš©)
        export DATABASE_URL="${{ secrets.DATABASE_URL }}"
        
        # í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹… ì¶œë ¥
        echo "ğŸ” DATABASE_URL í™•ì¸:"
        echo "- í™˜ê²½ ë³€ìˆ˜ì— DATABASE_URL ì¡´ì¬ ì—¬ë¶€: $(if [ -n "$DATABASE_URL" ]; then echo "ìˆìŒ"; else echo "ì—†ìŒ"; fi)"
        echo "- DATABASE_URL ê¸¸ì´: ${#DATABASE_URL} ê¸€ì"
        
        # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (.env.production)
        echo "ğŸ”„ .env.production íŒŒì¼ ìƒì„± ì¤‘..."
        echo "DATABASE_URL=$DATABASE_URL" > .env.production
        echo "NODE_ENV=production" >> .env.production
        echo "SKIP_MIGRATION=true" >> .env.production  # Azureì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê±´ë„ˆë›°ê¸° í”Œë˜ê·¸ ì¶”ê°€
        
        # íŒŒì¼ ë‚´ìš© í™•ì¸ (ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹í•˜ì—¬ ì¶œë ¥)
        echo "ğŸ” .env.production íŒŒì¼ ë‚´ìš© í™•ì¸:"
        grep -v "DATABASE_URL" .env.production || true
        echo "DATABASE_URL=********(ì„¤ì •ë¨)********"
        
        # env.production íŒŒì¼ë„ ìƒì„± (ì  ì—†ëŠ” ë²„ì „, Azureì—ì„œ ìˆ¨ê¹€ íŒŒì¼ ë¬¸ì œ ë°©ì§€)
        cp .env.production env.production
        echo "âœ… env.production íŒŒì¼ë„ ìƒì„± ì™„ë£Œ"
        
        # ë§ˆì´ê·¸ë ˆì´ì…˜ í™˜ê²½ ì¤€ë¹„ í™•ì¸
        ls -la drizzle.config.* || true
        
        # drizzle-kitì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (global ì„¤ì¹˜ ì‹œë„)
        echo "ğŸ” drizzle-kit ì„¤ì¹˜ ìƒíƒœ í™•ì¸..."
        if ! npm list -g drizzle-kit &> /dev/null; then
          echo "ğŸ”„ drizzle-kitì„ ê¸€ë¡œë²Œë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
          npm install -g drizzle-kit
          echo "âœ… drizzle-kit ê¸€ë¡œë²Œ ì„¤ì¹˜ ì™„ë£Œ"
        else
          echo "âœ… drizzle-kitì´ ì´ë¯¸ ê¸€ë¡œë²Œë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        fi
        
        # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ë¡œì»¬ drizzle-kit ëª¨ë“ˆ ì•„ë‹ˆë¼ ê¸€ë¡œë²Œ drizzle-kit ì‚¬ìš©)
        echo "ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤..."
        
        # 1. ê¸€ë¡œë²Œ drizzle-kit ì§ì ‘ ì‹¤í–‰ 
        echo "ë°©ë²• 1: ê¸€ë¡œë²Œ drizzle-kit push ì‹¤í–‰"
        DATABASE_URL="$DATABASE_URL" drizzle-kit push || true
        
        # 2. SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰
        echo "ë°©ë²• 2: SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë° ì‹¤í–‰"
        # SQL ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
        DATABASE_URL="$DATABASE_URL" drizzle-kit generate:pg --out=./migration.sql || true
        
        # migration.sql íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if [ -f "./migration.sql" ]; then
          echo "âœ… SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ë¨"
          echo "ğŸ’¾ migration.sql ë‚´ìš©:"
          cat ./migration.sql | grep -v 'password' || true
          
          # ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ Azureì— í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ ë³µì‚¬
          cp ./migration.sql deployment/ || true
        else
          echo "âš ï¸ SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ìµœì‹  ìƒíƒœì¼ ìˆ˜ ìˆìŒ)"
        fi
        
        echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"
    
    - name: Prepare deployment package
      run: |
        # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ í¬í•¨í•˜ëŠ” ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p deployment/client
        
        # í´ë¼ì´ì–¸íŠ¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„ (client/distê°€ ì—†ìœ¼ë¯€ë¡œ client/src ì‚¬ìš©)
        echo "í™•ì¸: client ë””ë ‰í† ë¦¬ êµ¬ì¡°"
        ls -la client/
        
        # ì„œë²„ ì‚¬ì´ë“œ ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ (dist)
        if [ -d dist ]; then
          cp -r dist deployment/
          echo "ì„œë²„ ë¹Œë“œ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: dist â†’ deployment/dist"
        else
          echo "ê²½ê³ : dist ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ ë¹Œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤."
        fi
        
        # client ë””ë ‰í† ë¦¬ ìƒì„± ë° í•„ìš”í•œ íŒŒì¼ ë³µì‚¬
        if [ -d client/dist ]; then
          cp -r client/dist deployment/client/
          echo "í´ë¼ì´ì–¸íŠ¸ ë¹Œë“œ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: client/dist â†’ deployment/client/dist"
        else
          # client/distê°€ ì—†ëŠ” ê²½ìš° client/srcë¥¼ ì§ì ‘ ë³µì‚¬
          mkdir -p deployment/client/src
          cp -r client/src deployment/client/
          echo "í´ë¼ì´ì–¸íŠ¸ ì†ŒìŠ¤ íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: client/src â†’ deployment/client/src"
        fi
        
        # node_modules ë° ê¸°íƒ€ í•„ìˆ˜ íŒŒì¼ ë³µì‚¬
        cp -r node_modules deployment/
        mkdir -p deployment/public/images deployment/public/static
        
        # í•„ìˆ˜ íŒŒì¼ ë³µì‚¬
        cp package.json package-lock.json startup.js patch-helper.js .deployment web.config deployment/
        
        # ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë ¨ íŒŒì¼ ë³µì‚¬
        cp drizzle.config.ts deployment/
        mkdir -p deployment/shared
        cp -r shared/* deployment/shared/ || echo "shared ë””ë ‰í† ë¦¬ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
        
        # Azure Kuduê°€ ìš”êµ¬í•˜ëŠ” server/startup.js ìƒì„±
        mkdir -p deployment/server
        echo "// Azure Kudu ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ í˜¸í™˜ì„± íŒŒì¼" > deployment/server/startup.js
        echo "import '../startup.js'; // ë£¨íŠ¸ì˜ startup.jsë¡œ ë¦¬ë””ë ‰ì…˜" >> deployment/server/startup.js
        echo "âœ… server/startup.js íŒŒì¼ ìƒì„± ì™„ë£Œ (Azure Kudu í˜¸í™˜ìš©)"
        
        # .env.production íŒŒì¼ì´ ìˆìœ¼ë©´ ë³µì‚¬
        if [ -f .env.production ]; then
          cp .env.production deployment/
          echo ".env.production íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
        fi
        
        # public ë””ë ‰í† ë¦¬ ë³µì‚¬ (ì´ë¯¸ ë””ë ‰í† ë¦¬ì¸ì§€ í™•ì¸ í›„)
        if [ -d public ] && [ ! -f public ]; then
          cp -r public/* deployment/public/
          echo "public ë””ë ‰í† ë¦¬ ì½˜í…ì¸  ë³µì‚¬ ì™„ë£Œ"
        else
          echo "ì£¼ì˜: publicì´ ë””ë ‰í† ë¦¬ê°€ ì•„ë‹ˆê±°ë‚˜ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          # public ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ êµ¬ì¡° ìƒì„±
          mkdir -p deployment/public/images deployment/public/static
          echo "ë¹ˆ public ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± ì™„ë£Œ"
        fi
        
        # ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
        echo "ìµœì¢… ë°°í¬ íŒ¨í‚¤ì§€ êµ¬ì¡°:"
        find deployment -type d | sort
        
        # ë°°í¬ ëŒ€ìƒ public ë””ë ‰í† ë¦¬ ìµœì¢… ê²€ì¦
        if [ -f deployment/public ]; then
          echo "ì˜¤ë¥˜: deployment/publicì´ íŒŒì¼ë¡œ ì¡´ì¬í•©ë‹ˆë‹¤!"
          rm deployment/public
          mkdir -p deployment/public/images deployment/public/static
          echo "public ë””ë ‰í† ë¦¬ êµ¬ì¡° ìˆ˜ì • ì™„ë£Œ"
        fi
    
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./deployment